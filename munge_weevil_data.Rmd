---
title: "munge population data"
author: "David Nguyen"
date: "March 17, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(readxl)
```

###
Are females unobserved or are the counts missing? 
The sheet "T 10 sex ratios" includes females counts for the 10 % peanut shell experiment that are not included in the "T10" sheet.
This is problematic, since population growth is likely more limited by females than by males.

Population T15-8 has 8 weevil population introductions compared to the 5 introduction in other replicates in T15-8. Is this correct?

In the sheets, some of the cols for "alive" have a highlighted header cell that says "pic". What does this mean? were the counts obtained by looking at a picture?

### Dropped data columsn
the column at the end that has the repeating sequence {a,b,c,d}?
dropped pellet count since, in this expt, all were feed 2 pellets per observation day.

### T15-8
what going on with that expt? in the blacked out cells, there are some data but the last male alive count is "???"
Edit - The data in the T15-8 sheet is different than the blacked-out columns in in the "15 %" sheet. The start date of the T15-8 replicate is different between sheets. I *think* that there was some sort of experimental problem with the original replicate 8 for the 15 % treatment, and that the T15-8 is a new replicate line. This explains why the start date in Dec 1st whereas the start dates for all other replicatees in the 15 % treatment began on Oct 25th

```{r, include = FALSE}
# get names of sheets that contain pop data (not including T15-8 for now)
sheet_names <- excel_sheets("weevil_data/pop_dynamics_expt_data.xlsx")
sheet_pops <- sheet_names[1:5]
pct_peanut_shells <- c(0, 0.03, 0.05, 0.10, 0.15)

# create new colnames
npop <- 10
date_cols <- c("days", "date")
demo_cols <- unlist(lapply(1:npop,
       function(i)
         c(paste0("m_alive_",i),
           paste0("f_alive_",i),
           paste0("total_alive_", i),
           paste0("m_dead_",i),
           paste0("f_dead_",i),
           paste0("total_dead_",i))))
treatment_cols <- c("m_added", "f_added", "pellets", "noclue", "treatment")

# read-in and reformat all population data sheets

list_dfs <- vector("list", length = length(sheet_pops)) # init list to store each df

# loop to read and reformat
for (i in seq_along(sheet_pops)) {
  df_now <-
    read_excel("weevil_data/pop_dynamics_expt_data.xlsx",
               skip = 3,
               sheet = sheet_pops[i]) %>%
    mutate(treatment = pct_peanut_shells[i])
  
  # assign new colnames
  names(df_now) <-
    c(date_cols, demo_cols, treatment_cols) # should include check to make sure all data sheets have same format
  
  # T15 has weird ??? in a col. CHange to NA and convert col to numeric
  if (i == 5) {
    df_now$m_alive_8 <-
      df_now %>% 
      mutate_at(vars('m_alive_8'), ~na_if(., '???')) %>%
      pull(m_alive_8) %>%
      as.numeric()
  }
  
  # make data longer for plotting
  df_long <- df_now %>%
    select(-pellets,-noclue) %>% # always 2 pellets a day, and drop noclue as well as the num. added
    filter(!is.na(days)) %>%  # drop empty bottom two rows (included when reading due to sum(pellets) in spread sheet)
    pivot_longer(
      -c(days, date, m_added, f_added,treatment),
      names_sep = "_",
      names_to = c("sex", "status", "replicate"),
      values_to = "count"
    ) %>%
    # original data file did not have totals computed for all days
    # create new df with totals for all days
    filter(sex != "total" , status == "alive") %>%
    group_by(date, replicate) %>%
    mutate(total = sum(count, na.rm = TRUE)) %>% # females were not observed after first few days
    ungroup()
  
  # save to list
  list_dfs[[i]] <- df_long
}

full_df <- bind_rows(list_dfs)

full_df <- full_df %>% mutate(replicate = as.numeric(replicate))
#full_df$treatment <- as_factor(full_df$treatment) # for proper facetting when plotting. Should convert to numeric instead.
```

to combine the extinction expt data and the pop dynamics data, I will need to change grouping variables.
There are a couple types of population lines:
+ peanut shell (constant or increasing)
    ++ there are two sets of 1:10 replicates, one that has constant peanut shell and the other is increasing
    ++ how should I account for this when merging data together? Ah, maybe adjust the treatment col to have elements in {food_cst, food_inc, harvest, avidin}. Then I could have seperate numeric cols like: pct_shell, harvest_rate, avidin.
+ harvested (increasing)
+ avidin treated (increasing)

Note, right now I'm dropping all of the counts of dead individuals. It may be important information to keep though.

```{r}
### now lets read and format data from ext_data.xlsx
### this has 90 times series of weevil abundances split between three groups:
### control (pure beans, and no harvesting)
### harvest (10 had linearly-increasing avidin treatment, 20 had linearly increasing harvesting)
### food    (all had linearly-increasing peanut shell percent)

# get names of relevant sheets
control_sheets <- excel_sheets("weevil_data/ext_data.xlsx")[1:3]
avidin_sheets <- excel_sheets("weevil_data/ext_data.xlsx")[4]
harvest_sheets <- excel_sheets("weevil_data/ext_data.xlsx")[5:6]
food_sheets <- excel_sheets("weevil_data/ext_data.xlsx")[7:9]

# read in sheet
# sheets each have replicates 1 - 10, 11 - 20, 21 - 30 
lower_rep <- c(1, 11, 21)
upper_rep <- c(10, 20, 30)

date_cols <- c("days", "date")
demo_cols_10 <- unlist(lapply(lower_rep[1]:upper_rep[1],
       function(i)
         c(paste0("m_alive_",i),
           paste0("f_alive_",i),
           paste0("total_alive_", i),
           paste0("m_dead_",i),
           paste0("f_dead_",i),
           paste0("total_dead_",i))))
treatment_cols <- c("m_added", "f_added", "pellets", "noclue")

raw_ctrl_10 <- read_excel("weevil_data/ext_data.xlsx", skip = 3, sheet = control_sheets[1]) %>%
  filter(!is.na(date) ) # cut out calculated values at bottom of spreadsheet

names(raw_ctrl_10) <- c(date_cols, demo_cols_10, treatment_cols)

# create new cols for all treatments
raw_ctrl_10 <- 
  raw_ctrl_10 %>%
  mutate(treatment = "food_cst",
         pct_shell = 0,
         avidin = 0,
         harvest = 0)

# lengthen data for plotting
ctrl_10 <-
  raw_ctrl_10 %>%
    select(-pellets,-noclue) %>% # always 2 pellets a day, and drop noclue as well as the num. added
    filter(!is.na(days)) %>%  # drop empty bottom two rows (included when reading due to sum(pellets) in spread sheet)
    pivot_longer(
      -c(days, date, m_added, f_added,treatment, pct_shell, avidin, harvest),
      names_sep = "_",
      names_to = c("sex", "status", "replicate"),
      values_to = "count"
    ) %>%
    # original data file did not have totals computed for all days
    # create new df with totals for all days
    filter(sex != "total" , status == "alive") %>%
    group_by(date, replicate) %>%
    mutate(total = sum(count, na.rm = TRUE)) %>% # females were not observed after first few days
    fill(m_added, f_added) %>% # fill in rest of zeros
    ungroup() 
```

```{r read_ext_control}
# read in sheet
# sheets each have replicates 1 - 10, 11 - 20, 21 - 30 
lower_rep <- c(1, 11, 21)
upper_rep <- c(10, 20, 30)

list_ctrl <- vector("list", length = length(control_sheets))

for (j in seq_along(control_sheets)) {
  date_cols <- c("days", "date")
demo_cols_10 <- unlist(lapply(lower_rep[j]:upper_rep[j],
       function(i)
         c(paste0("m_alive_",i),
           paste0("f_alive_",i),
           paste0("total_alive_", i),
           paste0("m_dead_",i),
           paste0("f_dead_",i),
           paste0("total_dead_",i))))
treatment_cols <- c("m_added", "f_added", "pellets", "noclue")

raw_ctrl <- read_excel("weevil_data/ext_data.xlsx", skip = 3, sheet = control_sheets[j]) %>%
  filter(!is.na(date) ) # cut out calculated values at bottom of spreadsheet

names(raw_ctrl) <- c(date_cols, demo_cols_10, treatment_cols)

# create new cols for all treatments
raw_ctrl <- 
  raw_ctrl %>%
  mutate(treatment = "food_cst",
         pct_shell = 0,
         avidin = 0,
         harvest = 0)

# lengthen data for plotting
list_ctrl[[j]] <-
  raw_ctrl %>%
    select(-pellets,-noclue) %>% # always 2 pellets a day, and drop noclue as well as the num. added
    filter(!is.na(days)) %>%  # drop empty bottom two rows (included when reading due to sum(pellets) in spread sheet)
    pivot_longer(
      -c(days, date, m_added, f_added,treatment, pct_shell, avidin, harvest),
      names_sep = "_",
      names_to = c("sex", "status", "replicate"),
      values_to = "count"
    ) %>%
    # original data file did not have totals computed for all days
    # create new df with totals for all days
    filter(sex != "total" , status == "alive") %>%
    group_by(date, replicate) %>%
    mutate(total = sum(count, na.rm = TRUE)) %>% # females were not observed after first few days
    fill(m_added, f_added) %>% # fill in rest of zeros
    ungroup() 

  
}

ctrl_df <- 
  bind_rows(list_ctrl) %>%
  filter(!is.na(count), sex == "m") %>% # cut out rows after experiment ended (e.g., no values recorded for male count)
  mutate(replicate = as.numeric(replicate) )
```

```{r ext_ctrl_plot}
ctrl_df %>%
  ggplot(aes(x = days, y = total, col = as.factor(replicate) )) +
  geom_line() +
  theme(legend.position = "n")

```



### now that i've pulled all data sets together, how can I automate data quality checks?
no clue. need to learn how.

### plot time series
note, that the observed abundance may not be reported correctly since female counts may have not been included in the data sheets for some reason.

```{r}
full_df %>%
  ggplot(aes(x = days, y = total, group = replicate, col = as.factor(replicate) )) +
  geom_line() + 
  facet_wrap(~treatment) +
  theme_light() +
  theme(legend.position = "none") +
  scale_x_continuous(breaks = seq(0, 650, by = 100)) +
  scale_y_continuous(breaks = seq(0, 50, by = 10)) +
  labs(title = "Bean weevil populations over time",
       subtitle = "For each plot, weevils were fed pellets with a different proportion of peanut shell additive.\nEach color is a different replicate.",
       y = "Bean weevil count",
       x = "Time (days)")

```

There are some interesting dynamics in the 5 % peanut shell treatment. Are these transient oscillations? 

Why is the 3 % treament so short? It is short because the 3 % experiment was started at a later date. All the experiments ended around the end of April, but most began in early fall. THe 3 % treatment started in March. See the following plot.

```{r}
full_df %>%
  ggplot(aes(x = date, y = total, group = replicate, col = as.factor(replicate) )) +
  geom_line() + 
  facet_wrap(~treatment) +
  theme_light() +
  theme(legend.position = "none") +
  #scale_x_continuous(breaks = seq(0, 650, by = 100)) +
  scale_y_continuous(breaks = seq(0, 50, by = 10)) +
  labs(title = "Bean weevil populations over time",
       subtitle = "For each plot, weevils were fed pellets with a different proportion of peanut shell additive.\nEach color is a different replicate.",
       y = "Bean weevil count",
       x = "Time (days)")

```

Interesting. So, it appears that at 0 - 3 % peanut shells, the weevils can reach a carrying capacity (or the stochastic equivalent). At 5 % peanut shells, they *appears* (at least to my eye) some transient oscillations. For the 10 - 15 % peanut shell treatments the trajectories were clearly declining from the start along with some oscillations before crashing.


### 0 % peanut shell

```{r}
# increments for x and y axis
inc_total <- 5
inc_days <- 50 

# get max days and total, each rounded to the nearest value of inc_*
spark_lims <- 
  full_df %>% 
  select(days, total) %>% 
  summarise(max_days = ceiling(max(days)/inc_days)*inc_days, 
            max_total = ceiling(max(total)/inc_total) * inc_total )

spark_list <- lapply(seq_along(pct_peanut_shells),
                     function(x)
                       full_df %>%
  filter(treatment == pct_peanut_shells[x]) %>%
  ggplot(aes(x = days, y = total)) +
  geom_line() +
  scale_y_continuous(breaks = seq(0, spark_lims$max_total, by = 2*inc_total),
                     limits = c(0, spark_lims$max_total)) +
  scale_x_continuous(breaks = seq(0, spark_lims$max_days, by = 2*inc_days),
                     limits = c(0, spark_lims$max_days)) +
  labs(title = paste0(pct_peanut_shells[x]*100, " % peanut shell in food pellets")) +
  facet_wrap(~replicate))

# 0 % peanut shells
spark_list[[1]]
```

```{r}
spark_list[[2]]
```

```{r}
spark_list[[3]]
```

```{r}
spark_list[[4]]
```

```{r}
spark_list[[5]]
```

### Sheet 3
Sheet 3 includes a limited duration of count data for each of the replicates. However, the data shown in Sheet 3 doesn't seem to match up with the data in the treatment specific sheets.

```{r, include = FALSE}
sheet3 <- 
  read_excel("weevil_data/pop_dynamics_expt_data.xlsx", sheet = 10, n_max = 21, skip = 2) %>%
  select(1:39) %>% # bunch of stuff in cols past 40, no clue what it is. Is not used in plots on sheet 3
  slice(-1) 

sheet3_names <- names(sheet3)

sheet3_names <- gsub("^\\...", NA, sheet3_names) %>% # if string begins with "..." replace it with NA
  tibble::enframe() %>%
  fill(value) %>%
  group_by(value) %>%
  mutate(index = row_number(),
         name = paste0(value, "_", index)) %>%
  pull(name)

names(sheet3) <- sheet3_names

sheet3 <-
  sheet3 %>%
  mutate(time_step = row_number()) %>%
  pivot_longer( -time_step, # contains("_"),
               names_sep = "_",
               names_to = c("treatment", "replicate"),
               values_to = "total") %>% 
  mutate(treatment = replace(treatment, treatment == "pure", "0.0")) %>%
  mutate(treatment = as.numeric(treatment)) 
    
```

How do the data presented in sheet 3 compare to the data in the treatement specific sheets?

### compare mean count plots

It is obvious that the data are not the same. Sheet 3 shows a transient peak around day ten for the 0.05 and pure treatments which is absent in the treatment specific plot.

```{r}
# plot of average total in sheet 3
sheet3 %>%
  group_by(time_step, treatment) %>%
  summarize(mean_count = mean(total)) %>%
  ungroup() %>%
  ggplot(aes(x = time_step, y = mean_count, group = treatment, col = as.factor(treatment))) +
  geom_line() + theme(legend.position = "n") +
  labs(title = "Sheet 3 - mean population count",
       y = "mean count across replicates",
       x = "time step (4 days?)")

full_df %>%
  group_by(treatment, days) %>%
  summarize(mean_count = mean(total)) %>%
  ungroup() %>%
  filter(days <= 4 * 19, treatment != 0.03) %>%
  ggplot(aes(x = days, y = mean_count, col = as.factor(treatment), group = treatment)) + 
  geom_line() + theme(legend.position = "n") +
  labs(title = "mean population count from treatment sheets")

```

```{r}
sheet3 %>%
  ggplot(aes(x = time_step, y = total, col = as.factor(treatment), group = replicate)) +
  geom_line() +
  facet_wrap(~treatment) +
  labs(title = "Sheet 3 - population count",
       y = "weevil count",
       x = "time step (4 days?)") +
  theme(legend.position = "n")

full_df %>%
  filter(days <= 4 * 19, treatment != 0.03) %>%
  ggplot(aes(x = days, y = total, col = as.factor(treatment), group = replicate)) + 
  geom_line() +
  facet_wrap(~treatment) +
  theme(legend.position = "n")
  
```

### what is the difference between replicate 8 in sheet 5 (15%) and sheet 6 ("T15-8")

```{r}
# get data from T15-8 and insert into the main data set
t15_8 <- read_excel("weevil_data/pop_dynamics_expt_data.xlsx",
               skip = 3,
               sheet = 6) %>%
  mutate(treatment = 0.15)

demo_names_8 <- c(paste0("m_alive_",8),
                  paste0("f_alive_",8),
                  paste0("total_alive_", 8),
                  paste0("m_dead_",8),
                  paste0("f_dead_",8),
                  paste0("total_dead_",8))
names(t15_8) <- c(date_cols, demo_names_8, treatment_cols)

t15_8 <- 
  t15_8 %>%
  select(-pellets,-noclue) %>% # always 2 pellets a day, and drop noclue as well as the num. added
    filter(!is.na(days)) %>%  # drop empty bottom two rows (included when reading due to sum(pellets) in spread sheet)
    pivot_longer(
      -c(days, date, m_added, f_added,treatment),
      names_sep = "_",
      names_to = c("sex", "status", "replicate"),
      values_to = "count"
    ) %>%
    # original data file did not have totals computed for all days
    # create new df with totals for all days
    filter(sex != "total" , status == "alive") %>%
    group_by(date, replicate) %>%
    mutate(total = sum(count, na.rm = TRUE)) %>% # females were not observed after first few days
    ungroup()

setdiff(names(t15_8), names(full_df))

failed_8_range <-
  full_df %>% 
  filter(treatment == 0.15, replicate == 8, total > 0) %>% 
  pull(date) %>%
  range()

t15_8_range <- t15_8 %>% 
  filter(total > 0) %>% 
  pull(date) %>% 
  range()

subset_8 <- 
  full_df %>% 
  filter(treatment == 0.15,
                   replicate == 8,
                   date <= failed_8_range[2],
                   date >= failed_8_range[1]) %>%
  mutate(which_8 = "failed?")

t15_8 <- t15_8 %>% mutate(which_8 = "successful?")  

rbind(t15_8, subset_8) %>% 
  ggplot(aes(x = date, y = total, col = which_8)) +
  geom_line()

```
